name: CI

on:
  push:
    branches: ["main", "claude/**"]
  pull_request:
    branches: ["main"]

jobs:
  test:
    name: Test Suite (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install test dependencies
        run: pip install pytest

      - name: Run unit and integration tests
        run: python -m pytest tests/ -v --tb=short

  headless-smoke:
    name: Headless Simulation Smoke Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Run headless simulation (200 ticks)
        run: python main.py --headless --ticks 200 --dt 0.1

      - name: Run headless simulation (1000 ticks â€” sustained throughput)
        run: python main.py --headless --ticks 1000 --dt 0.05

  recipe-catalog:
    name: Recipe Catalog Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install test dependencies
        run: pip install pytest

      - name: Validate recipe catalog only
        run: python -m pytest tests/test_recipe_catalog.py -v --tb=short

      - name: Verify catalog loads and covers all unlock tiers
        run: |
          python - <<'EOF'
          import sys
          from pathlib import Path
          sys.path.insert(0, ".")
          from recipe_catalog import load_recipe_catalog

          catalog = load_recipe_catalog(Path("data/recipes.json"))
          assert len(catalog) >= 20, f"Expected >=20 recipes, got {len(catalog)}"

          tiers = {r["unlock_tier"] for r in catalog.values()}
          assert 0 in tiers, "Must have tier-0 (starter) recipes"
          assert max(tiers) >= 2, "Must span at least 3 unlock tiers"

          for key, recipe in catalog.items():
              assert recipe["sell_price"] >= 1, f"{key}: sell_price must be >= 1"
              assert recipe["sla"] > 0, f"{key}: sla must be positive"
              assert recipe["demand_weight"] > 0, f"{key}: demand_weight must be positive"
              assert len(recipe["toppings"]) >= 1, f"{key}: must have at least 1 topping"

          print(f"OK: {len(catalog)} recipes validated across tiers {sorted(tiers)}")
          EOF
